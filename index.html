<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>æ–‡ä»¶æ‹ç…§è½‰ PDFï¼ˆæ‰‹å‹•è£åˆ‡ï¼‹å¤šç¨®æ•ˆæœï¼‰</title>
  <link rel="manifest" href="manifest.json?v=20250811-1">
  <link rel="icon" href="icon.png?v=20250811-1" type="image/png">
  <link href="https://unpkg.com/cropperjs@1.5.13/dist/cropper.min.css" rel="stylesheet"/>
  <style>
    body { font-family: Arial, sans-serif; margin: 2em; background: #fff; }
    h2 { margin-top:0; }
    .preview { display: flex; flex-wrap: wrap; gap: 10px; margin: 1em 0; }
    .preview-item {
      position: relative;
      cursor: grab;
      border: 2px solid transparent;
      border-radius:6px;
    }
    .preview-item.dragging { opacity: .4; }
    .preview-item.drag-over { border-color:#1976d2; }
    .preview-item img { width: 120px; height: auto; border: 1px solid #aaa; border-radius: 4px; display:block; }
    .remove-btn {
      position: absolute; top: 2px; right: 2px;
      background: rgba(255,0,0,0.85); color: #fff; border: none; border-radius: 3px;
      cursor: pointer; font-size: 12px; padding: 2px 6px;
    }
    .actions {
      margin-bottom: 1em;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.5em;
    }
    .actions input[type="file"] { display:none; }
    .actions button {
      flex: 0 0 auto;
      font-size: 0.95em;
      border: none;
      background: #f5f5f5;
      color: #333;
      padding: 0.65em 1.05em;
      border-radius: 6px;
      cursor:pointer;
    }
    .actions button:hover, .actions button:focus { background:#e0e0e0; }
    #loading { display:none; color:#006; font-weight:bold; }
    #localInfo { font-size:0.75em; color:#666; }
    #cropperModal {
      display:none;
      position:fixed;
      inset:0;
      width:100vw; height:100vh;
      background:rgba(0,0,0,0.8);
      align-items:center;
      justify-content:center;
      z-index:9999;
      overscroll-behavior: contain;
    }
    #cropperModal .modal-content {
      background:#fff;
      padding:1em 0.5em;
      border-radius:10px;
      max-width:95vw;
      max-height:80vh;
      text-align:center;
      overflow-y:auto;
      display:flex;
      flex-direction:column;
      align-items:center;
    }
    #cropperTip {
      font-size:0.95em;
      color:#555;
      margin:.4em 0 .6em;
      font-weight:bold;
      line-height:1.4;
    }
    #cropperImage {
      max-width:82vw;
      max-height:28vh;
      margin-bottom:0.5em;
      touch-action:none;
      border:1px solid #eee;
      background:#fafafa;
      border-radius:4px;
      box-sizing:border-box;
      display:block;
    }
    .cropper-point {
      width:30px !important;
      height:30px !important;
      background-color:#2196F3 !important;
      opacity:0.8 !important;
      border-radius:50% !important;
    }
    #effectSelect {
      font-size:1em;
      margin:0 1em;
      padding:0.35em 0.8em;
      border-radius:5px;
      border:1px solid #b0b0b0;
      background:#fafafa;
      color:#333;
    }
    #cropperBtns {
      min-height:55px;
      margin-top:1.1em;
      display:flex;
      gap:1em;
      flex-wrap:wrap;
      justify-content:center;
      width:100%;
    }
    #cropperBtns button {
      min-width:90px;
      font-size:0.95em;
      padding:0.63em 1.05em;
      background:#f5f5f5;
      color:#333;
      border-radius:6px;
      border:none;
      cursor:pointer;
    }
    #cropperBtns button:hover { background:#e0e0e0; }
    @media (max-width:500px) {
      #cropperModal .modal-content { padding:0.6em 0.2em 0.9em; }
      #cropperImage { max-width:98vw; max-height:24vh; }
      #cropperBtns button { font-size:0.9em; min-width:70px; padding:0.5em 0.7em; }
      .actions { gap:0.35em; }
    }

    /* å°æç¤ºæ¢ */
    #hintBar {
      font-size:0.75em;
      background:#fafafa;
      border:1px solid #e3e3e3;
      padding:0.5em 0.8em;
      border-radius:6px;
      color:#444;
      line-height:1.4;
      max-width:640px;
    }

    /* LINE è­¦å‘Šå½ˆçª— */
    #lineWarningModal { font-size:0.95em; }
  </style>
  <script src="https://unpkg.com/cropperjs@1.5.13/dist/cropper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>
<body>
  <!-- LINEç€è¦½å™¨è­¦å‘Šå½ˆçª— -->
  <div id="lineWarningModal" style="display:none;position:fixed;z-index:99999;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.7);align-items:center;justify-content:center;">
    <div style="background:#fff;padding:2em 1em;border-radius:12px;max-width:90vw;text-align:center;box-shadow:0 6px 24px #0002;">
      <h3 style="color:#1976d2;margin-top:0;">âš ï¸ æç¤º</h3>
      <div style="font-size:1.05em;color:#444;margin:1em 0 1.4em;font-weight:bold;">
        å»ºè­°ä½¿ç”¨é è¨­ç€è¦½å™¨ï¼ˆSafari / Chromeï¼‰ï¼Œ<br>LINE å…§å»ºç€è¦½å™¨å¯èƒ½åŠŸèƒ½ä¸å®Œæ•´ã€‚
      </div>
      <button id="openInBrowserBtn" style="font-size:0.95em;padding:0.7em 1.4em;border-radius:8px;border:none;background:#1976d2;color:#fff;box-shadow:0 2px 8px #0001;cursor:pointer;">
        ç”¨é è¨­ç€è¦½å™¨é–‹å•Ÿæœ¬é 
      </button>
      <br><br>
      <button onclick="document.getElementById('lineWarningModal').style.display='none'" style="color:#1976d2;background:#fff;border:1px solid #1976d2;padding:0.45em 1.1em;border-radius:7px;font-size:0.85em;cursor:pointer;">
        é—œé–‰
      </button>
    </div>
  </div>

  <h2>ğŸ“„ æ–‡ä»¶æ‹ç…§è½‰ PDFï¼ˆæ‰‹å‹•è£åˆ‡ï¼‹å¤šç¨®æ•ˆæœï¼‰</h2>

  <div id="hintBar">
    åŠŸèƒ½ï¼š1) è£åˆ‡ï¼‹æ¿¾é¡ 2) è‡ªå‹•åˆ¤æ–· PDF æ©«/ç›´å‘ 3) æ‹–æ›³ç¸®åœ–èª¿æ•´é †åº 4) è‡ªå‹•æš«å­˜ï¼ˆé‡æ–°æ•´ç†ä¸æœƒæ¶ˆå¤±ï¼‰<br>
    æç¤ºï¼šæ‹–æ›³ç¸®åœ–æ”¹é †åºï¼›å¤§é‡åœ–ç‰‡å¯èƒ½è¶…å‡ºç€è¦½å™¨ localStorageï¼ˆç´„ 5MBï¼‰ã€‚
  </div>

  <div class="actions" style="margin-top:0.9em;">
    <input type="file" accept="image/*" capture="environment" id="cameraInput">
    <input type="file" accept="image/*" multiple id="fileInput">
    <button onclick="document.getElementById('cameraInput').click()">ğŸ“· æ‹ç…§</button>
    <button onclick="document.getElementById('fileInput').click()">ğŸ–¼ï¸ é¸ç…§ç‰‡</button>
    <button onclick="generatePDF()">ğŸ§¾ ç”¢ç”Ÿ PDF</button>
    <button onclick="clearAllImages()" style="background:#ffecec;color:#b80000;">ğŸ—‘ï¸ æ¸…é™¤å…¨éƒ¨</button>
    <button onclick="clearLocalOnly()" style="background:#f2f8ff;color:#0b64c0;">ğŸ§¹ æ¸…é™¤æš«å­˜</button>
    <span id="loading">è™•ç†ä¸­...</span>
  </div>
  <div id="localInfo"></div>
  <div class="preview" id="preview"></div>

  <!-- è£åˆ‡ Modal -->
  <div id="cropperModal">
    <div class="modal-content">
      <div id="cropperTip">
        å–®æŒ‡æ‹–æ›³ç§»å‹•ã€é›™æŒ‡ç¸®æ”¾ã€é»åœ“é»èª¿æ•´è£åˆ‡<br>
        <span style="color:#1976d2;">å¦‚åç§»è«‹ç”¨ã€Œé‡è¨­ã€</span>
      </div>
      <img id="cropperImage" alt="å¾…è£åˆ‡åœ–ç‰‡">
      <div style="margin-top:0.6em;">
        <label for="effectSelect">æ•ˆæœï¼š</label>
        <select id="effectSelect">
          <option value="original">åŸè‰²</option>
          <option value="gray">ç°éš</option>
          <option value="bw">é»‘ç™½ï¼ˆå¼·åŒ–å°æ¯”ï¼‰</option>
        </select>
      </div>
      <div id="cropperBtns">
        <button id="cropResetBtn" type="button">é‡è¨­</button>
        <button id="cropConfirmBtn" type="button">ç¢ºå®šè£åˆ‡</button>
        <button id="cropCancelBtn" type="button">å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <script>
    /********************
     * LINE ç€è¦½å™¨åˆ¤æ–· *
     ********************/
    function isLineBrowser() {
      return navigator.userAgent.toLowerCase().indexOf('line') !== -1;
    }
    function getCurrentUrl() {
      return window.location.href.split('#')[0];
    }
    function openInBrowser() {
      const url = getCurrentUrl();
      if (/android/i.test(navigator.userAgent)) {
        const intentUrl = 'intent://' + url.replace(/^https?:\/\//,'') + '#Intent;scheme=https;package=com.android.chrome;end';
        window.location = intentUrl;
      } else if (/iphone|ipad|ipod/i.test(navigator.userAgent)) {
        window.open(url, '_blank');
      } else {
        window.open(url, '_blank');
      }
    }

    /********************
     * å…¨åŸŸè³‡æ–™èˆ‡å¸¸æ•¸   *
     ********************/
    const { jsPDF } = window.jspdf;
    let images = [];                 // åªå­˜ DataURL
    let cropper = null;
    const LS_KEY = 'doc2pdf_images_v1';
    const SAVE_DEBOUNCE = 400;
    let saveTimer = null;

    /********************
     * æ¿¾é¡è™•ç†å‡½å¼     *
     ********************/
    function toGray(canvas) {
      const ctx = canvas.getContext('2d');
      let d = ctx.getImageData(0, 0, canvas.width, canvas.height);
      for (let i=0; i<d.data.length; i+=4) {
        const r=d.data[i], g=d.data[i+1], b=d.data[i+2];
        const gray = 0.299*r + 0.587*g + 0.114*b;
        d.data[i]=d.data[i+1]=d.data[i+2]=gray;
      }
      ctx.putImageData(d,0,0);
      return canvas;
    }
    function toBW(canvas) {
      const ctx = canvas.getContext('2d');
      let d = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const hist = new Array(256).fill(0);
      for (let i=0; i<d.data.length; i+=4) {
        const r=d.data[i], g=d.data[i+1], b=d.data[i+2];
        const gray = 0.299*r + 0.587*g + 0.114*b;
        d.data[i]=d.data[i+1]=d.data[i+2]=gray;
        hist[Math.round(gray)]++;
      }
      // Otsu
      let total = canvas.width * canvas.height;
      let sum=0;
      for (let t=0; t<256; t++) sum += t * hist[t];
      let sumB=0, wB=0, wF=0, varMax=0, threshold=0;
      for (let t=0; t<256; t++) {
        wB += hist[t];
        if (!wB) continue;
        wF = total - wB;
        if (!wF) break;
        sumB += t * hist[t];
        const mB = sumB / wB;
        const mF = (sum - sumB) / wF;
        const varBetween = wB * wF * (mB - mF) * (mB - mF);
        if (varBetween > varMax) {
          varMax = varBetween;
            threshold = t;
        }
      }
      for (let i=0; i<d.data.length; i+=4) {
        const v = d.data[i] > threshold ? 255 : 0;
        d.data[i]=d.data[i+1]=d.data[i+2]=v;
      }
      ctx.putImageData(d,0,0);
      return canvas;
    }

    /********************
     * è‡ªå‹•æš«å­˜åŠŸèƒ½     *
     ********************/
    function saveStateDebounced() {
      clearTimeout(saveTimer);
      saveTimer = setTimeout(saveState, SAVE_DEBOUNCE);
    }
    function saveState() {
      try {
        const payload = {
          images,
          ts: Date.now()
        };
        localStorage.setItem(LS_KEY, JSON.stringify(payload));
        updateLocalInfo();
      } catch (e) {
        console.error('å„²å­˜å¤±æ•—ï¼š', e);
        alert('åœ–ç‰‡æš«å­˜è¶…å‡ºç€è¦½å™¨é™åˆ¶ï¼Œç„¡æ³•å†ä¿å­˜ã€‚\nå»ºè­°ï¼šåˆªé™¤éƒ¨åˆ†åœ–ç‰‡æˆ–ç«‹å³åŒ¯å‡º PDFã€‚');
      }
    }
    function loadState() {
      try {
        const raw = localStorage.getItem(LS_KEY);
        if (!raw) return;
        const data = JSON.parse(raw);
        if (Array.isArray(data.images)) {
          images = data.images;
          updatePreview();
        }
        updateLocalInfo();
      } catch(e) {
        console.warn('è®€å–æš«å­˜å¤±æ•—', e);
      }
    }
    function clearLocalOnly() {
      localStorage.removeItem(LS_KEY);
      updateLocalInfo();
      alert('å·²æ¸…é™¤ç€è¦½å™¨æš«å­˜ï¼ˆä¸å½±éŸ¿ç›®å‰ç•«é¢åœ–ç‰‡ï¼‰ã€‚');
    }
    function clearAllImages() {
      if (!confirm('ç¢ºå®šæ¸…é™¤å…¨éƒ¨åœ–ç‰‡ï¼Ÿï¼ˆæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼‰')) return;
      images = [];
      updatePreview();
      saveState();
    }
    function updateLocalInfo() {
      const infoEl = document.getElementById('localInfo');
      const raw = localStorage.getItem(LS_KEY);
      if (!raw) {
        infoEl.textContent = 'æš«å­˜ï¼šç„¡';
        return;
      }
      // ç²—ä¼°å¤§å° (å­—ä¸²é•·åº¦)
      const bytes = new Blob([raw]).size;
      const kb = (bytes/1024).toFixed(1);
      const mb = (bytes/1024/1024).toFixed(2);
      infoEl.textContent = `æš«å­˜ï¼š${images.length} å¼µï¼Œç´„ ${kb} KB (${mb} MB)`;
    }

    /********************
     * è£åˆ‡ Modal é«˜åº¦   *
     ********************/
    function setModalContentHeight() {
      const safeHeight = window.innerHeight - 28;
      const modalContent = document.querySelector('#cropperModal .modal-content');
      if (modalContent) modalContent.style.maxHeight = safeHeight + 'px';
    }

    /********************
     * é–‹å•Ÿè£åˆ‡          *
     ********************/
    function openCropper(imageSrc, callback) {
      const modal = document.getElementById('cropperModal');
      const cropperImg = document.getElementById('cropperImage');
      cropperImg.src = imageSrc;
      modal.style.display = 'flex';
      setModalContentHeight();
      window.addEventListener('resize', setModalContentHeight);
      let cropperInstance = null;
      cropperImg.onload = () => {
        cropperInstance = new Cropper(cropperImg, {
          viewMode: 1,
            aspectRatio: NaN,
            movable: true,
            zoomable: true,
            rotatable: true,
            scalable: true,
            autoCropArea: 1,
            minCropBoxWidth: 50,
            minCropBoxHeight: 50,
            dragMode: 'move',
            toggleDragModeOnDblclick: false
        });
        cropper = cropperInstance;
      };
      document.getElementById('cropResetBtn').onclick = () => {
        if (cropperInstance) cropperInstance.reset();
      };
      document.getElementById('cropConfirmBtn').onclick = () => {
        if (!cropperInstance) return;
        const effect = document.getElementById('effectSelect').value;
        const croppedCanvas = cropperInstance.getCroppedCanvas();
        const resultCanvas = document.createElement('canvas');
        resultCanvas.width = croppedCanvas.width;
        resultCanvas.height = croppedCanvas.height;
        resultCanvas.getContext('2d').drawImage(croppedCanvas,0,0);
        if (effect === 'gray') toGray(resultCanvas);
        else if (effect === 'bw') toBW(resultCanvas);
        cropperInstance.destroy();
        modal.style.display = 'none';
        window.removeEventListener('resize', setModalContentHeight);
        callback(resultCanvas.toDataURL('image/jpeg', 0.92));
      };
      document.getElementById('cropCancelBtn').onclick = () => {
        if (cropperInstance) cropperInstance.destroy();
        modal.style.display = 'none';
        window.removeEventListener('resize', setModalContentHeight);
      };
    }

    /********************
     * è™•ç†æª”æ¡ˆ          *
     ********************/
    function handleFiles(fileList) {
      if (!fileList.length) return;
      document.getElementById('loading').style.display = '';
      let idx = 0;
      function next() {
        if (idx >= fileList.length) {
          document.getElementById('loading').style.display = 'none';
          return;
        }
        const file = fileList[idx];
        if (!file.type.startsWith('image/')) { idx++; next(); return; }
        const reader = new FileReader();
        reader.onload = e => {
          openCropper(e.target.result, croppedDataUrl => {
            images.push(croppedDataUrl);
            updatePreview();
            saveStateDebounced();
            idx++;
            next();
          });
        };
        reader.readAsDataURL(file);
      }
      next();
    }

    document.getElementById('cameraInput').addEventListener('change', e => {
      handleFiles(e.target.files);
      e.target.value = '';
    });
    document.getElementById('fileInput').addEventListener('change', e => {
      handleFiles(e.target.files);
      e.target.value = '';
    });

    /********************
     * é è¦½èˆ‡æ‹–æ›³æ’åº    *
     ********************/
    function updatePreview() {
      const preview = document.getElementById('preview');
      preview.innerHTML = '';
      images.forEach((src, i) => {
        const div = document.createElement('div');
        div.className = 'preview-item';
        div.draggable = true;
        div.dataset.index = i;

        const img = document.createElement('img');
        img.src = src;
        img.alt = 'ç¬¬ ' + (i+1) + ' å¼µåœ–ç‰‡';
        img.onerror = function(){ this.src='icon.png?v=20250811-1'; };

        const btn = document.createElement('button');
        btn.className = 'remove-btn';
        btn.textContent = 'âœ–';
        btn.title = 'åˆªé™¤é€™å¼µ';
        btn.onclick = () => {
          images.splice(i,1);
          updatePreview();
          saveStateDebounced();
        };

        // Drag events
        div.addEventListener('dragstart', dragStart);
        div.addEventListener('dragover', dragOver);
        div.addEventListener('dragleave', dragLeave);
        div.addEventListener('drop', dragDrop);
        div.addEventListener('dragend', dragEnd);

        div.appendChild(img);
        div.appendChild(btn);
        preview.appendChild(div);
      });
      updateLocalInfo();
    }

    let dragSrcIndex = null;

    function dragStart(e) {
      dragSrcIndex = +this.dataset.index;
      this.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      try { e.dataTransfer.setData('text/plain', dragSrcIndex); } catch(_) {}
    }
    function dragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      if (!this.classList.contains('drag-over')) this.classList.add('drag-over');
    }
    function dragLeave() {
      this.classList.remove('drag-over');
    }
    function dragDrop(e) {
      e.preventDefault();
      this.classList.remove('drag-over');
      const targetIndex = +this.dataset.index;
      if (dragSrcIndex === null || targetIndex === dragSrcIndex) return;
      // é‡æ–°æ’åº
      const moved = images.splice(dragSrcIndex, 1)[0];
      images.splice(targetIndex, 0, moved);
      updatePreview();
      saveStateDebounced();
    }
    function dragEnd() {
      const items = document.querySelectorAll('.preview-item');
      items.forEach(it => it.classList.remove('dragging','drag-over'));
      dragSrcIndex = null;
    }

    /********************
     * ç”¢ç”Ÿ PDF (æ©«ç›´)  *
     ********************/
    function getPdfFilename() {
      const now = new Date();
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth()+1).padStart(2,'0');
      const dd = String(now.getDate()).padStart(2,'0');
      const hh = String(now.getHours()).padStart(2,'0');
      const min = String(now.getMinutes()).padStart(2,'0');
      const ss = String(now.getSeconds()).padStart(2,'0');
      return `${yyyy}${mm}${dd}_${hh}${min}${ss}_è½‰æª”.pdf`;
    }

    function generatePDF() {
      if (images.length === 0) {
        alert('è«‹å…ˆæ–°å¢æˆ–è£åˆ‡å®Œæˆåœ–ç‰‡');
        return;
      }
      // é å…ˆè¼‰å…¥æ‰€æœ‰åœ–ç‰‡ (ç¢ºä¿çŸ¥é“å¯¬é«˜)
      const pdfImages = [];
      let loaded = 0;
      images.forEach((src, idx) => {
        const img = new Image();
        img.onload = function() {
          pdfImages[idx] = img;
          loaded++;
          if (loaded === images.length) buildPDF(pdfImages);
        };
        img.src = src;
      });
    }

    function buildPDF(pdfImages) {
      let pdf = null;
      pdfImages.forEach((img, idx) => {
        const landscape = img.width > img.height;
        const orientation = landscape ? 'landscape' : 'portrait';
        if (idx === 0) {
          pdf = new jsPDF({ unit:'pt', format:'a4', orientation });
        } else {
          pdf.addPage('a4', orientation);
        }
        const pdfW = pdf.internal.pageSize.getWidth();
        const pdfH = pdf.internal.pageSize.getHeight();
        const ratio = Math.min(pdfW / img.width, pdfH / img.height);
        const w = img.width * ratio;
        const h = img.height * ratio;
        const x = (pdfW - w)/2;
        const y = (pdfH - h)/2;
        pdf.addImage(img, 'JPEG', x, y, w, h);
      });
      pdf.save(getPdfFilename());
    }

    /********************
     * åˆå§‹åŒ–            *
     ********************/
    window.addEventListener('DOMContentLoaded', () => {
      if (isLineBrowser()) {
        document.getElementById('lineWarningModal').style.display='flex';
        document.getElementById('openInBrowserBtn').onclick = openInBrowser;
      }
      loadState();
    });

    /********************
     * Service Worker    *
     ********************/
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js?v=20250811-1').catch(()=>{});
    }
  </script>
</body>
</html>
